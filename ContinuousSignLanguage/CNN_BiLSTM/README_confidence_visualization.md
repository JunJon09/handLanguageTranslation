# 時系列予測確率・信頼度可視化機能

## 概要

手話認識モデルの**予測信頼度**を時系列で詳細に分析する可視化機能です。CTC 出力から各時刻での予測の確実性・不確実性を定量化し、視覚的に把握できます。

## 機能

### 1. 予測信頼度タイムライン

4 つの信頼度指標を時系列で可視化：

#### A. 最大確率 (Maximum Probability)

- **意味**: 各時刻で最も確信の高いクラスの確率
- **範囲**: 0.0 - 1.0
- **解釈**: 高いほど予測に確信がある

#### B. 予測エントロピー (Prediction Entropy)

- **意味**: 確率分布の不確実性を表す
- **計算式**: `-Σ P(t)log(P(t))`
- **解釈**: 低いほど予測が集中している（確実）

#### C. 信頼度ギャップ (Confidence Gap)

- **意味**: 1 位と 2 位の確率の差
- **範囲**: 0.0 - 1.0
- **解釈**: 大きいほど予測が明確に分離

#### D. 確実性指数 (Certainty Index)

- **意味**: 最大確率の相対的強さ
- **計算式**: `最大確率 / 確率分布の標準偏差`
- **解釈**: 高いほど他のクラスと差が大きい

### 2. 単語レベル信頼度分析

- **単語別信頼度**: 予測された各単語の平均確率
- **信頼度分類**: 高・中・低の 3 段階評価
- **バー表示**: 色分けされた視覚的表示

## 既存 CTC 可視化との違い

| 項目         | CTC 確率可視化           | 新・信頼度可視化           |
| ------------ | ------------------------ | -------------------------- |
| **目的**     | どのクラスが予測されたか | 予測にどれだけ確信があるか |
| **Y 軸**     | 確率値 (0-1)             | 信頼度指標                 |
| **表示内容** | 全クラス確率             | 信頼度メトリクス           |
| **分析観点** | 予測内容                 | 予測品質                   |

## 使用方法

### 1. 基本設定

```python
# predict.py での設定
VISUALIZE_CONFIDENCE = True  # 信頼度可視化を有効化
```

### 2. 実行

```bash
cd /path/to/CNN_BiLSTM
python continuous_sign_language/modeling/predict.py
```

### 3. 出力ファイル

#### A. 信頼度タイムライン

- **ファイル名**: `confidence_timeline_batch_X.png`
- **内容**: 4 つの信頼度指標の時系列変化

#### B. 単語レベル信頼度

- **ファイル名**: `word_confidence_batch_X.png`
- **内容**: 単語別信頼度バーチャート + 時系列

## 出力解釈ガイド

### 信頼度パターン分析

#### 1. 高信頼度パターン

```
最大確率: 高い (> 0.7)
エントロピー: 低い (< 2.0)
信頼度ギャップ: 大きい (> 0.3)
確実性指数: 高い (> 5.0)
```

→ **解釈**: 明確で確実な予測

#### 2. 低信頼度パターン

```
最大確率: 低い (< 0.4)
エントロピー: 高い (> 4.0)
信頼度ギャップ: 小さい (< 0.1)
確実性指数: 低い (< 2.0)
```

→ **解釈**: 曖昧で不確実な予測

#### 3. 不安定パターン

```
各指標が時系列で大きく変動
```

→ **解釈**: 予測が時間的に一貫していない

### ログ出力例

```
=== 予測信頼度分析結果 ===
最大確率 - 平均: 0.7234, 標準偏差: 0.1456
エントロピー - 平均: 2.1234, 標準偏差: 0.8765
信頼度ギャップ - 平均: 0.4567, 標準偏差: 0.2134
確実性指数 - 平均: 6.7890, 標準偏差: 2.3456

高信頼度フレーム (上位25%): 12個
低信頼度フレーム (下位25%): 8個
高不確実性フレーム (エントロピー上位25%): 10個

予測安定性:
確率変動性: 0.0234
不確実性変動性: 0.1234

総合信頼度スコア: 0.8456

=== 単語別予測信頼度 ===
friend: 0.8234 (高信頼度)
station: 0.6789 (中信頼度)
meet: 0.4321 (中信頼度)
```

## 応用例

### 1. モデル改善

- 低信頼度時刻の特徴分析
- 不安定予測の原因調査
- データ拡張の優先順位決定

### 2. リアルタイム応用

- 信頼度閾値による予測フィルタリング
- 不確実時の再実行判定
- ユーザーへの信頼度表示

### 3. データセット分析

- 困難サンプルの特定
- アノテーション品質の評価
- バイアス検出

## カスタマイズ

### 信頼度閾値の調整

```python
# plots.py 内
confidence_threshold = 0.5  # デフォルト
high_confidence_percentile = 75  # 上位25%
```

### 表示する指標の選択

```python
# 特定の指標のみ表示
plot_prediction_confidence_over_time(
    log_probs,
    metrics=['max_prob', 'entropy']  # カスタム実装
)
```

## 技術詳細

### 信頼度指標の数学的定義

1. **最大確率**: `max_prob = max(P(t))`
2. **エントロピー**: `entropy = -Σ P(t)log(P(t))`
3. **信頼度ギャップ**: `gap = P₁(t) - P₂(t)`
4. **確実性指数**: `certainty = max(P(t)) / std(P(t))`

### データフロー

```
CTC出力 → Softmax → 確率分布 → 信頼度指標計算 → 可視化
```

## トラブルシューティング

### よくある問題

1. **log_probs が取得できない**

   ```
   CTC log_probsが取得できませんでした
   ```

   → モデルの forward 実装を確認

2. **信頼度値が異常**

   ```
   確実性指数が極端に高い/低い
   ```

   → 確率分布の分散を確認

3. **可視化エラー**
   ```
   予測信頼度可視化でエラー
   ```
   → 入力データの形状を確認

### デバッグ情報

```python
logging.getLogger().setLevel(logging.DEBUG)
# 詳細な確率分布データが出力される
```

## 次のステップ

1. **Feature Visualization** - t-SNE/UMAP による特徴空間分析
2. **予測の因果関係分析** - 注意機構との組み合わせ
3. **リアルタイム信頼度監視** - ストリーミング対応

## 参考文献

- **エントロピー**: Information Theory 基礎
- **予測信頼度**: Machine Learning Uncertainty Quantification
- **CTC**: Connectionist Temporal Classification
